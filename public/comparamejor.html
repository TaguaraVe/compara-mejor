<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Compara Mejor</title>
    <link rel="stylesheet" href="/styles.css" />

    <script type="module">
      // TableauEventType represents the type of Tableau embedding event that can be listened for.
      import { TableauEventType } from 'https://public.tableau.com/javascripts/api/tableau.embedding.3.latest.js';

      // List of visualizations to cycle through.
      const vizList = [
        'https://prod-useast-a.online.tableau.com/#/site/jml2/views/2023-7-20comparamejorsql/Home?:origin=card_share_link&:embed=n',
        'https://prod-useast-a.online.tableau.com/#/site/jml2/views/2023-7-20comparamejorsql/ComparadordeCatalogo?:origin=card_share_link&:embed=n',
        'https://prod-useast-a.online.tableau.com/#/site/jml2/views/2023-7-20comparamejorsql/ComparadordePrecios?:origin=card_share_link&:embed=n',
      ];

      let vizLen = vizList.length,
        vizCount = 0;

      //  ---------------------
      async function getToken() {
        const apiUrl = 'https://tableau-token-generator.vercel.app/token';

        try {
          const response = await fetch(apiUrl);
          if (!response.ok) {
            throw new Error('Error en la respuesta de la API');
          }
          const data = await response.json();
          console.log('Datos de la API:', data.token);

          function handleFirstInteractive(e) {
            console.log(`Viz loaded: ${viz.src}`);
          }

          // Determine the correct visualization to display.
          function loadViz(vizPlusMinus) {
            vizCount = vizCount + vizPlusMinus;

            if (vizCount >= vizLen) {
              // Keep the vizCount in the bounds of the array index.
              vizCount = 0;
            } else if (vizCount < 0) {
              vizCount = vizLen - 1;
            }

            viz.src = vizList[vizCount];
          }

          let viz = document.getElementById('tableauViz');

          // Event fired when a viz first becomes interactive.
          viz.addEventListener(
            TableauEventType.FirstInteractive,
            handleFirstInteractive
          );
          viz.src = vizList[0];
          viz.id = '6b94cee6-0733-456a-af57-e84176d41180';
          console.log('first antese de asigna a viz.token', data.token);
          viz.token = data.token;
          console.log('despues viz.token', viz.token);

          // Attach event handlers to the "previous" and "next" button clicks.
          document.getElementById('previous').onclick = () => loadViz(-1);
          document.getElementById('next').onclick = () => loadViz(1);
        } catch (error) {
          console.error('Error al obtener datos de la API:', error);
        }
      }
      getToken();
      setInterval(() => {
        getToken();
        console.log(' set interva', token);
      }, 1 * 60 * 1000);
    </script>
  </head>

  <body>
    <!-- Initialization of the Tableau visualization. -->
    <header class="header" id="header">
      <div class="nav__logo">
        <a href="index.html"
          ><img src="./assets/img/logos/logo.png" alt="Compara Mejor Logo"
        /></a>
      </div>
    </header>
    <h1 class="title">Compara Mejor</h1>
    <!-- Buttons to show the previous or next visualization. -->
    <div id="controls" class="button-wrapper">
      <button class="button" id="previous">Anterior</button>
      <button class="button" id="next">Siguiente</button>
    </div>
    <div class="tableau-wrapper">
      <tableau-viz id="tableauViz" hide-tabs></tableau-viz>
    </div>
    <!-- Buttons to show the previous or next visualization. -->
  </body>
</html>
